{"version":3,"sources":["../../../lib/interactiveCli/set-app.js"],"names":["require","createApp","createAccessKeyForTenant","getApps","getLoggedInUser","listTenants","refreshToken","writeConfigFile","enableConfirm","writeTenantAndApp","isValidAppName","RegExp","prototype","test","bind","tenantsChoice","inquirer","tenantNames","prompt","message","type","name","choices","Array","from","tenantName","appNameChoice","appNames","concat","value","appName","appNameInput","validate","input","trim","includes","module","exports","check","serverless","config","servicePath","service","provider","tenant","app","user","tenants","Set","idToken","Object","keys","accessKeys","add","username","map","size","run","interactiveCli","values","next","has","token","users","userId","dashboard","apps","length","chosenAppName","newAppName"],"mappings":"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","sourcesContent":["'use strict';\n\nconst {\n  createApp,\n  createAccessKeyForTenant,\n  getApps,\n  getLoggedInUser,\n  listTenants,\n  refreshToken,\n  writeConfigFile,\n} = require('@serverless/platform-sdk');\nconst enableConfirm = require('./enableConfirm');\nconst writeTenantAndApp = require('./writeTenantAndApp');\n\nconst isValidAppName = RegExp.prototype.test.bind(/^[a-z0-9](?:[a-z0-9-]{0,126}[a-z0-9])?$/);\n\nconst tenantsChoice = async (inquirer, tenantNames) =>\n  (await inquirer.prompt({\n    message: 'What tenant do you want to add this to?',\n    type: 'list',\n    name: 'tenantName',\n    choices: Array.from(tenantNames),\n  })).tenantName;\n\nconst appNameChoice = async (inquirer, appNames) =>\n  (await inquirer.prompt({\n    message: 'What application do you want to add this to?',\n    type: 'list',\n    name: 'appName',\n    choices: Array.from(appNames).concat({ name: '[create a new app]', value: '_create_' }),\n  })).appName;\n\nconst appNameInput = async (inquirer, appNames) =>\n  (await inquirer.prompt({\n    message: 'What do you want to name this application?',\n    type: 'input',\n    name: 'appName',\n    validate: input => {\n      input = input.trim();\n      if (!isValidAppName(input)) {\n        return (\n          'App name is not valid.\\n' +\n          '   - It should only contain lowercase alphanumeric and hyphens.\\n' +\n          '   - It should start and end with an alphanumeric character.\\n' +\n          \"   - Shouldn't exceed 128 characters\"\n        );\n      }\n      if (appNames.includes(input)) return 'App of this name already exists';\n      return true;\n    },\n  })).appName.trim();\n\nmodule.exports = {\n  async check(serverless) {\n    if (!serverless.config.servicePath) return false;\n    if (serverless.service.provider.name !== 'aws') return false;\n    if (serverless.service.tenant && serverless.service.app) return false;\n    let user = getLoggedInUser();\n    let tenants = new Set();\n    if (!user) {\n      return false;\n    } else if (!user.idToken) {\n      for (const tenant of Object.keys(user.accessKeys)) {\n        tenants.add(tenant);\n      }\n    } else {\n      await refreshToken();\n      user = getLoggedInUser();\n      tenants = new Set(\n        (await listTenants({ username: user.username, idToken: user.idToken })).map(\n          tenant => tenant.tenantName\n        )\n      );\n    }\n    if (!tenants.size) return false;\n    return { user, tenants };\n  },\n  async run(serverless, { user, tenants }) {\n    const { inquirer } = serverless.interactiveCli;\n    if (!serverless.service.tenant) {\n      if (!(await enableConfirm(inquirer))) return null;\n    }\n\n    const tenantName = await (async () => {\n      if (tenants.size === 1) return tenants.values().next().value;\n      if (serverless.service.tenant && tenants.has(serverless.service.tenant)) {\n        return serverless.service.tenant;\n      }\n      return tenantsChoice(inquirer, tenants);\n    })();\n\n    let token;\n    if (user.accessKeys && user.accessKeys[tenantName]) {\n      token = user.accessKeys[tenantName];\n    } else {\n      token = await createAccessKeyForTenant(tenantName);\n      await writeConfigFile({\n        users: { [user.userId]: { dashboard: { accessKeys: { [tenantName]: token } } } },\n      });\n    }\n    const apps = await getApps({ tenant: tenantName, token });\n\n    const appName = await (async () => {\n      const appNames = apps.map(app => app.appName);\n      if (serverless.service.app && appNames.includes(serverless.service.app)) {\n        return serverless.service.app;\n      }\n      if (apps.length) {\n        const chosenAppName = await appNameChoice(inquirer, appNames);\n        if (chosenAppName !== '_create_') return chosenAppName;\n      }\n      const newAppName = await appNameInput(inquirer, appNames);\n      return (await createApp({ tenant: tenantName, app: newAppName, token })).appName;\n    })();\n\n    return writeTenantAndApp(serverless, tenantName, appName);\n  },\n};\n"],"file":"set-app.js"}